<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LARP Staff Map</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    #container { display:flex; height:100vh; }
    #mapwrap { flex:1; padding:12px; box-sizing:border-box; overflow:auto; background:#f7f7f7; display:flex; align-items:center; justify-content:center; }
    #svgContainer { width:100%; max-width:1200px; border:1px solid #ddd; background:#fff; position:relative; }
    aside { width:360px; border-left:1px solid #eee; padding:12px; box-sizing:border-box; overflow:auto; }
    .zone { padding:8px; border-bottom:1px solid #eee; }
    .btn { display:inline-block; padding:6px 10px; border-radius:6px; color:#fff; background:#007bff; text-decoration:none; cursor:pointer; }
    .btn.ghost { background:transparent; color:#007bff; border:1px solid #d0e4ff; }
    .status-completed { color:green; font-weight:bold; }
.loading-spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid #ffffff40;
  border-top-color: #ffffff;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 6px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

  </style>
</head>
<body>
  <div id="container">
    <div id="mapwrap">
      <div id="svgContainer">
        <!-- The SVG map goes here -->
        <object id="siteMap" data="site.svg" type="image/svg+xml" style="width:100%; height:auto;"></object>
      </div>
    </div>

    <aside>
      <h3 id="zoneTitle">Select an area</h3>
      <p id="userNameDisplay" style="font-size:14px; color:#555; margin-top:-8px;"></p>

      <div>
        <label>Team:
          <select id="teamFilter">
            <option value="">All</option>
            <option value="build">build</option>
            <option value="electrical">electrical</option>
            <option value="sanitation">sanitation</option>
            <option value="faction">faction</option>
          </select>
        </label>
      </div>

      <div id="jobList" style="margin-top:12px;">
        <p>No area selected.</p>
      </div>
    </aside>
  </div>

<script>
const SHEET_URL =
  "https://script.google.com/macros/s/AKfycby-HJoS8SXC6q0qGuhAK0cs3KvImbuWC94MlAPt8RvfwRsZ7PWqIsJ3DxheiuVUuSECjQ/exec"; // <-- your Apps Script URL

let zones = [];
let jobs = [];
let currentZoneId = null;
  // --- User Identification ---
let currentUser = localStorage.getItem("larpUserName");

if (!currentUser) {
  currentUser = prompt("Please enter your name:");
  if (!currentUser || currentUser.trim() === "") {
    currentUser = "Unknown"; // fallback
  }
  localStorage.setItem("larpUserName", currentUser);
}

// Display name in sidebar
document.getElementById("userNameDisplay").textContent = `Logged in as: ${currentUser}`;

// Fetch zones and jobs
async function fetchZonesAndJobs() {
  console.log("Fetching zones and jobs...");
  try {
    // ✅ Note the `callback=cb` instead of `jsonp=callback`
    const response = await fetch(`${SHEET_URL}?callback=cb`);
    const text = await response.text();

    // ✅ Parse JSONP properly
    const jsonText = text.replace(/^cb\(|\);?$/g, "");
    const data = JSON.parse(jsonText);

    zones = (data.zones || []).filter(z => z.svg_id);
    jobs = data.jobs || [];

    console.log(`Loaded zones: ${zones.length}, jobs: ${jobs.length}`);
    setupZoneInteractions();
  } catch (err) {
    console.error("Failed to fetch zones/jobs:", err);
  }
}

// Setup click events on SVG shapes
function setupZoneInteractions() {
  const svgObject = document.getElementById("siteMap");
  if (!svgObject || !svgObject.contentDocument) {
    console.error("SVG not loaded yet");
    return;
  }

  const svgDoc = svgObject.contentDocument;
  console.log("Zones to bind:", zones.map(z => z.svg_id));

  zones.forEach(zone => {
    const shape = svgDoc.getElementById(zone.svg_id);
    if (!shape) {
      console.warn(`⚠️ Shape not found for zone ${zone.svg_id}`);
      return;
    }

    shape.style.cursor = "pointer";
    shape.addEventListener("click", () => selectZone(zone.svg_id));
    console.log("Bound click to shape:", zone.svg_id);
  });
}

// Select a zone and display its jobs
function selectZone(zoneId) {
  currentZoneId = zoneId;
  const zoneName = zones.find(z => z.svg_id === zoneId)?.zone_name || zoneId;
  const listDiv = document.getElementById("jobList");
  listDiv.innerHTML = `<h2 class="text-xl font-bold mb-2">${zoneName}</h2>`;

  const zoneJobs = jobs.filter(j => j.zone_id === zoneId.replace(/^zone-/, ""));
  console.log(`Zone ${zoneId} has ${zoneJobs.length} jobs`);

  if (zoneJobs.length === 0) {
    listDiv.innerHTML += `<p>No active jobs for this zone</p>`;
    return;
  }

  zoneJobs.forEach(job => {
    const jobDiv = document.createElement("div");
    jobDiv.className = "border rounded p-2 mb-2 bg-white shadow";

    const title = document.createElement("div");
    title.textContent = (job.title && job.title.trim() !== "") 
  ? job.title 
  : `Job ${job.job_id}`;
    title.className = "font-semibold cursor-pointer";

    const completeBtn = document.createElement("button");
    completeBtn.id = `complete-${job.job_id}`;  
    completeBtn.textContent = "Mark complete";
    completeBtn.className =
      "bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded ml-2";

    completeBtn.addEventListener("click", e => {
      e.stopPropagation();
      completeJob(job.job_id);
    });

    // Expand job details on click
    title.addEventListener("click", () => {
      const existing = jobDiv.querySelector(".job-details");
      if (existing) {
        existing.remove();
        return;
      }

      const details = document.createElement("div");
      details.className = "job-details mt-2 text-sm text-gray-700";

     details.innerHTML = `
  <p>${(job.description && job.description.trim() !== "") ? job.description : "No description available."}</p>
  ${
    job.photo_url
      ? `<img src="${job.photo_url}" class="mt-2 rounded shadow-md" style="max-height:150px;">`
      : ""
  }
`;

      jobDiv.appendChild(details);
    });

    jobDiv.appendChild(title);
    jobDiv.appendChild(completeBtn);
    listDiv.appendChild(jobDiv);
  });
}

function completeJob(jobId) {
  const button = document.querySelector(`#complete-${jobId}`);
  if (!button) return;

  // Disable button + show spinner
  button.disabled = true;
  const originalHTML = button.innerHTML;
  button.innerHTML = `<span class="loading-spinner"></span> Updating…`;

  const url = `${SHEET_URL}?action=update&job_id=${jobId}&status=completed&completed_by=${encodeURIComponent(currentUser)}&user=${encodeURIComponent(currentUser)}&token=rtyaddsv42r-skdjfh0&callback=cb`;

  fetch(url)
    .then(r => r.text())
    .then(text => {
      const jsonText = text.replace(/^cb\(|\);?$/g, "");
      const data = JSON.parse(jsonText);

      console.log("Job marked complete:", data);

      if (data.ok) {
        // Remove job from memory
        jobs = jobs.filter(j => j.job_id !== jobId);

        // Refresh UI
        if (currentZoneId) selectZone(currentZoneId);

      } else {
        console.error("Update returned error", data.error);
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
    })
    .catch(err => {
      console.error("Error completing job:", err);
      button.disabled = false;
      button.innerHTML = originalHTML;
    });
}



// Reload zones when SVG is ready
document.getElementById("siteMap").addEventListener("load", () => {
  console.log("SVG loaded, binding zones...");
  setupZoneInteractions();
});

// Start up
fetchZonesAndJobs();
</script>

</body>
</html>

