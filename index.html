<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LARP Staff Map</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    #container { display:flex; height:100vh; }
    #mapwrap { flex:1; padding:12px; box-sizing:border-box; overflow:auto; background:#f7f7f7; display:flex; align-items:center; justify-content:center; }
    #svgContainer { width:100%; max-width:1200px; border:1px solid #ddd; background:#fff; position:relative; }
    aside { width:360px; border-left:1px solid #eee; padding:12px; box-sizing:border-box; overflow:auto; }
    .zone { padding:8px; border-bottom:1px solid #eee; }
    .btn { display:inline-block; padding:6px 10px; border-radius:6px; color:#fff; background:#007bff; text-decoration:none; cursor:pointer; }
    .btn.ghost { background:transparent; color:#007bff; border:1px solid #d0e4ff; }
    .status-completed { color:green; font-weight:bold; }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapwrap">
      <div id="svgContainer">
        <!-- The SVG map goes here -->
        <object id="siteMap" data="site.svg" type="image/svg+xml" style="width:100%; height:auto;"></object>
      </div>
    </div>

    <aside>
      <h3 id="zoneTitle">Select an area</h3>
      <div>
        <label>Team:
          <select id="teamFilter">
            <option value="">All</option>
            <option value="build">build</option>
            <option value="electrical">electrical</option>
            <option value="sanitation">sanitation</option>
            <option value="faction">faction</option>
          </select>
        </label>
      </div>

      <div id="jobList" style="margin-top:12px;">
        <p>No area selected.</p>
      </div>
    </aside>
  </div>

<script>
const SHEET_URL =
  "https://script.google.com/macros/s/AKfycbwCAlLUifVXcRbq1zWUXg3Ykq6geNXenCiL2Fn4CwG2cF77Sb6HhEl0aSwBU2LRTqU1HA/exec"; // <-- your Apps Script URL

let zones = [];
let jobs = [];
let currentZoneId = null;

// Fetch zones and jobs
async function fetchZonesAndJobs() {
  console.log("Fetching zones and jobs...");
  try {
    const response = await fetch(`${SHEET_URL}?callback=cb`);
    const text = await response.text();
    const jsonText = text.replace(/^cb\(|\);$/g, "");
    const data = JSON.parse(jsonText);

    zones = data.zones.filter(z => z.svg_id);
    jobs = data.jobs || [];
    console.log(`Loaded zones: ${zones.length}, jobs: ${jobs.length}`);

    setupZoneInteractions();
  } catch (err) {
    console.error("Failed to fetch zones/jobs:", err);
  }
}

// Setup click events on SVG shapes
function setupZoneInteractions() {
  const svgObject = document.getElementById("siteMap");
  if (!svgObject || !svgObject.contentDocument) {
    console.error("SVG not loaded yet");
    return;
  }

  const svgDoc = svgObject.contentDocument;
  console.log("Zones to bind:", zones.map(z => z.svg_id));

  zones.forEach(zone => {
    const shape = svgDoc.getElementById(zone.svg_id);
    if (!shape) {
      console.warn(`⚠️ Shape not found for zone ${zone.svg_id}`);
      return;
    }

    shape.style.cursor = "pointer";
    shape.addEventListener("click", () => selectZone(zone.svg_id));
    console.log("Bound click to shape:", zone.svg_id);
  });
}

// Select a zone and display its jobs
function selectZone(zoneId) {
  currentZoneId = zoneId;
  const zoneName = zones.find(z => z.svg_id === zoneId)?.zone_name || zoneId;
  const listDiv = document.getElementById("jobList");
  listDiv.innerHTML = `<h2 class="text-xl font-bold mb-2">${zoneName}</h2>`;

  const zoneJobs = jobs.filter(j => j.zone_id === zoneId.replace(/^zone-/, ""));
  console.log(`Zone ${zoneId} has ${zoneJobs.length} jobs`);

  if (zoneJobs.length === 0) {
    listDiv.innerHTML += `<p>No active jobs for this zone</p>`;
    return;
  }

  zoneJobs.forEach(job => {
    const jobDiv = document.createElement("div");
    jobDiv.className = "border rounded p-2 mb-2 bg-white shadow";

    const title = document.createElement("div");
    title.textContent = job.job_title || "Untitled job";
    title.className = "font-semibold cursor-pointer";

    const completeBtn = document.createElement("button");
    completeBtn.textContent = "Mark complete";
    completeBtn.className =
      "bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded ml-2";

    completeBtn.addEventListener("click", e => {
      e.stopPropagation();
      completeJob(job.job_id);
    });

    // Expand job details on click
    title.addEventListener("click", () => {
      const existing = jobDiv.querySelector(".job-details");
      if (existing) {
        existing.remove();
        return;
      }

      const details = document.createElement("div");
      details.className = "job-details mt-2 text-sm text-gray-700";

      details.innerHTML = `
        <p>${job.job_description || "No description available."}</p>
        ${
          job.photo_url
            ? `<img src="${job.photo_url}" class="mt-2 rounded shadow-md" style="max-height:150px;">`
            : ""
        }
      `;
      jobDiv.appendChild(details);
    });

    jobDiv.appendChild(title);
    jobDiv.appendChild(completeBtn);
    listDiv.appendChild(jobDiv);
  });
}

// Mark a job as complete
function completeJob(jobId) {
  fetch(`${SHEET_URL}?complete=${jobId}`)
    .then(r => r.json())
    .then(data => {
      console.log("Job marked complete:", data);
      jobs = jobs.filter(j => j.job_id !== jobId); // remove job
      if (currentZoneId) selectZone(currentZoneId); // refresh zone list

      const confirmMsg = document.createElement("div");
      confirmMsg.textContent = `✅ Job ${jobId} marked complete`;
      confirmMsg.className = "text-green-700 text-sm mt-2 fade-out";
      document.querySelector("#jobList").appendChild(confirmMsg);
      setTimeout(() => confirmMsg.remove(), 2000);
    })
    .catch(err => console.error("Error completing job:", err));
}

// Reload zones when SVG is ready
document.getElementById("siteMap").addEventListener("load", () => {
  console.log("SVG loaded, binding zones...");
  setupZoneInteractions();
});

// Start up
fetchZonesAndJobs();
</script>

</body>
</html>

