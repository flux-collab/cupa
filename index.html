<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LARP Staff Map</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    #container { display:flex; height:100vh; }
    #mapwrap { flex:1; padding:12px; box-sizing:border-box; overflow:auto; background:#f7f7f7; display:flex; align-items:center; justify-content:center; }
    #svgContainer { width:100%; max-width:1200px; border:1px solid #ddd; background:#fff; position:relative; }
    aside { width:360px; border-left:1px solid #eee; padding:12px; box-sizing:border-box; overflow:auto; }
    .zone { padding:8px; border-bottom:1px solid #eee; }
    .btn { display:inline-block; padding:6px 10px; border-radius:6px; color:#fff; background:#007bff; text-decoration:none; cursor:pointer; }
    .btn.ghost { background:transparent; color:#007bff; border:1px solid #d0e4ff; }
    .status-completed { color:green; font-weight:bold; }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapwrap">
      <div id="svgContainer">
        <!-- The SVG map goes here -->
        <object id="siteMap" data="site.svg" type="image/svg+xml" style="width:100%; height:auto;"></object>
      </div>
    </div>

    <aside>
      <h3 id="zoneTitle">Select an area</h3>
      <div>
        <label>Team:
          <select id="teamFilter">
            <option value="">All</option>
            <option value="build">build</option>
            <option value="electrical">electrical</option>
            <option value="sanitation">sanitation</option>
            <option value="faction">faction</option>
          </select>
        </label>
      </div>

      <div id="jobList" style="margin-top:12px;">
        <p>No area selected.</p>
      </div>
    </aside>
  </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwXpjpotXDNoGLggWB4FmBe9EW0Z05W1IvoQLnsF7xrRAlvkzP2IJ9dKboBeE1fLYs8Rw/exec";
const TOKEN = "rtyaddsv42r-skdjfh0";

let zones = [];
let jobs = [];
let currentZoneId = null;

// Fetch data from Google Apps Script
async function fetchZonesAndJobs() {
  console.log("Fetching zones and jobs...");
  try {
    const response = await fetch(`${WEB_APP_URL}?token=${TOKEN}&jsonp=callback`);
    const text = await response.text();

    // Extract JSON from JSONP
    const jsonText = text.replace(/^callback\(|\);?$/g, "");
    const data = JSON.parse(jsonText);

    zones = data.zones || [];
    jobs = data.jobs || [];
    console.log("Loaded zones:", zones.length, "jobs:", jobs.length);
  } catch (err) {
    console.error("Failed to fetch zones/jobs:", err);
  }
}

// Select a zone when user clicks an area on the SVG
function selectZone(zoneId) {
  console.log("Selected zone:", zoneId);
  currentZoneId = zoneId.replace(/^zone-/, ""); // normalise ID
  renderJobList();
}

// Render job list (filtered by team + zone)
function renderJobList() {
  const list = document.getElementById("jobList");
  list.innerHTML = "";

  if (!currentZoneId) {
    list.innerHTML = "<p>No area selected.</p>";
    return;
  }

  const selectedTeam = document.getElementById("teamFilter").value;
  const zoneJobs = jobs.filter(j =>
    j.zone_id === currentZoneId &&
    j.status !== "completed" &&
    (!selectedTeam || j.team === selectedTeam)
  );

  if (zoneJobs.length === 0) {
    list.innerHTML = "<li>No active jobs for this zone</li>";
    return;
  }

  zoneJobs.forEach(job => {
    const li = document.createElement("li");
    li.setAttribute("data-job-id", job.job_id);
    li.textContent = `${job.job_id} – ${job.title || job.description || "Unnamed job"}`;

    const btn = document.createElement("button");
    btn.textContent = "Mark complete";
    btn.onclick = () => markJobComplete(job.job_id);
    btn.style.marginLeft = "10px";

    li.appendChild(btn);
    list.appendChild(li);
  });
}

// Mark a job complete
function markJobComplete(jobId) {
  console.log("Completing job:", jobId);
  fetch(`${WEB_APP_URL}?token=${TOKEN}&job_id=${jobId}&complete=true`)
    .then(r => r.json())
    .then(data => {
      console.log("Job marked complete:", data);

      // Remove from local jobs list
      jobs = jobs.filter(j => j.job_id !== jobId);

      // Refresh current zone list
      renderJobList();

      // Confirmation message
      const confirmMsg = document.createElement("div");
      confirmMsg.textContent = `✅ Job ${jobId} marked complete`;
      confirmMsg.className = "text-green-700 text-sm mt-2 fade-out";
      document.querySelector("#jobList").appendChild(confirmMsg);
      setTimeout(() => confirmMsg.remove(), 2000);
    })
    .catch(err => console.error("Error completing job:", err));
}

// Initialise SVG and event listeners
window.addEventListener("DOMContentLoaded", async () => {
  const obj = document.getElementById("siteMap");

  // Wait for both fetchZonesAndJobs() and SVG load to finish
  const [_, svgLoaded] = await Promise.all([
    fetchZonesAndJobs(),
    new Promise(resolve => {
      if (obj.contentDocument) return resolve();
      obj.addEventListener("load", resolve);
    })
  ]);

  const svgDoc = obj.contentDocument;
  console.log("SVG and data loaded; attaching click handlers...");

  zones.forEach(zone => {
    const shape = svgDoc.getElementById(zone.svg_id);
    if (shape) {
      shape.style.cursor = "pointer";
      shape.addEventListener("click", () => selectZone(zone.svg_id));
      console.log("Attached click for", zone.svg_id);
    } else {
      console.warn("SVG shape not found for", zone.svg_id);
    }
  });

  // Team filter listener
  document.getElementById("teamFilter").addEventListener("change", renderJobList);
});
</script>

</body>
</html>

