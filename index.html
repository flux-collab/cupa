<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LARP Staff Map</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    #container { display:flex; height:100vh; }
    #mapwrap { flex:1; padding:12px; box-sizing:border-box; overflow:auto; background:#f7f7f7; display:flex; align-items:center; justify-content:center; }
    #svgContainer { width:100%; max-width:1200px; border:1px solid #ddd; background:#fff; }
    aside { width:360px; border-left:1px solid #eee; padding:12px; box-sizing:border-box; overflow:auto; }
    .zone { padding:8px; border-bottom:1px solid #eee; }
    .btn { display:inline-block; padding:6px 10px; border-radius:6px; color:#fff; background:#007bff; text-decoration:none; cursor:pointer; }
    .btn.ghost { background:transparent; color:#007bff; border:1px solid #d0e4ff; }
    .status-completed { color:green; font-weight:bold; }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapwrap">
      <div id="svgContainer">
        <p style="padding:12px; color:#666;">Loading site imageâ€¦</p>
      </div>
    </div>

    <aside>
      <h3 id="zoneTitle">Select an area</h3>
      <div>
        <label>Team:
          <select id="teamFilter">
            <option value="">All</option>
            <option value="build">build</option>
            <option value="electrical">electrical</option>
            <option value="sanitation">sanitation</option>
            <option value="faction">faction</option>
          </select>
        </label>
      </div>

      <div id="jobList" style="margin-top:12px;">
        <p>No area selected.</p>
      </div>
    </aside>
  </div>

<script>
/* ======= CONFIG - update these ======= */
const API_BASE = "https://script.google.com/macros/s/AKfycbwXpjpotXDNoGLggWB4FmBe9EW0Z05W1IvoQLnsF7xrRAlvkzP2IJ9dKboBeE1fLYs8Rw/exec";
const WRITE_TOKEN = "rtyaddsv42r-skdjfh0";
/* ===================================== */

let zonesMeta = {};
let allJobsCache = [];
let currentZone = null;

/* JSONP helper */
function jsonpFetch(url, timeout = 10000){
  return new Promise((resolve, reject) => {
    const cb = 'cb' + Math.random().toString(36).substr(2,9);
    window[cb] = function(data){ cleanup(); resolve(data); };
    const s = document.createElement('script');
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };
    document.head.appendChild(s);
    const tid = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeout);
    function cleanup(){ clearTimeout(tid); try{ document.head.removeChild(s); }catch(e){} try{ delete window[cb]; }catch(e){} }
  });
}

/* Fetch zones & jobs via JSONP */
async function fetchZonesAndJobs(){
  try {
    const resp = await jsonpFetch(API_BASE, 10000);
    if(!resp || !resp.ok) { console.warn('API returned not ok:', resp); zonesMeta={}; allJobsCache=[]; return {zones:[], jobs:[]}; }
    zonesMeta = {};
    (resp.zones || []).forEach(z => { if(z.svg_id) zonesMeta[z.svg_id] = { zone_id: z.zone_id, zone_name: z.zone_name, svg_id: z.svg_id }; });
    allJobsCache = resp.jobs || [];
    return { zones: resp.zones || [], jobs: resp.jobs || [] };
  } catch(err){
    console.error('Failed to fetch zones/jobs:', err);
    zonesMeta = {}; allJobsCache = [];
    return { zones: [], jobs: [] };
  }
}

/* Update job (via JSONP GET update) */
function updateJobViaJsonp(jobId, status){
  const params = new URLSearchParams();
  params.set('action','update');
  params.set('job_id', jobId);
  params.set('status', status);
  params.set('token', WRITE_TOKEN);
  const url = API_BASE + '?' + params.toString();
  return jsonpFetch(url, 10000);
}

/* Inline load SVG file and attach handlers */
async function loadInlineSVG(url = 'site.svg'){
  try {
    const r = await fetch(url);
    if(!r.ok) throw new Error('Failed to load SVG: ' + r.status);
    const svgText = await r.text();
    const container = document.getElementById('svgContainer');
    container.innerHTML = svgText;

    // runtime fixes: make background non-interactive, ensure zone elements accept events
    const svgRoot = container.querySelector('svg');
    if(!svgRoot) throw new Error('SVG element not found after inlining');
    // set background image pointer-events none if present
    const bg = svgRoot.querySelector('image');
    if(bg){ bg.style.pointerEvents = 'none'; bg.setAttribute('pointer-events','none'); }
    // ensure zone IDs are pointer-active
    Array.from(svgRoot.querySelectorAll('[id]')).forEach(el => {
      if(/^zone[-_]?/i.test(el.id)){
        el.style.pointerEvents = 'auto';
        el.setAttribute('pointer-events','auto');
      }
    });

    attachRobustSvgClickHandler(svgRoot);
    return svgRoot;
  } catch(err){
    console.error(err);
    document.getElementById('svgContainer').innerHTML = '<div style="color:red; padding:12px;">Unable to load SVG: '+err.message+'</div>';
  }
}

/* Robust click handler finds topmost zone element under cursor */
function attachRobustSvgClickHandler(svgEl){
  if(!svgEl) return;
  svgEl.addEventListener('click', function(e){
    const px = e.clientX, py = e.clientY;
    const stack = (document.elementsFromPoint) ? document.elementsFromPoint(px, py) : [document.elementFromPoint(px, py)];
    const zoneEl = stack.find(el => el && el.id && ( /^zone[-_]?/i.test(el.id) || (zonesMeta && zonesMeta[el.id]) ));
    if(zoneEl){
      const svgId = zoneEl.id;
      // set UI state
      currentZone = { svg_id: svgId, zone_id: (zonesMeta[svgId] ? zonesMeta[svgId].zone_id : svgId.replace(/^zone[-_]/i,'')), zone_name: (zonesMeta[svgId] ? zonesMeta[svgId].zone_name : svgId.replace(/[_-]/g,' ')) };
      document.getElementById('zoneTitle').textContent = currentZone.zone_name;
      refreshJobsFromAPI().then(()=>renderJobList());
    } else {
      console.log('Click stack (no zone):', stack.slice(0,8).map(x => ({id:x && x.id, tag: x && x.tagName})));
    }
  }, false);
}

/* Refresh cache */
async function refreshJobsFromAPI(){
  const res = await fetchZonesAndJobs();
  return res;
}

/* Render job list for currentZone */
function renderJobList(){
  const list = document.getElementById('jobList');
  list.innerHTML = '';
  if(!currentZone){ list.innerHTML = '<p>No area selected.</p>'; return; }
  const team = document.getElementById('teamFilter').value;
  const jobs = (allJobsCache || []).filter(j => String(j.zone_id) === String(currentZone.zone_id) && (!team || String(j.team) === team));
  if(jobs.length === 0){ list.innerHTML = '<p>No jobs found.</p>'; return; }
  jobs.forEach(job => {
    const div = document.createElement('div'); div.className = 'zone';
    div.innerHTML = `<h4>${(job.title||job.job_id)}</h4>
      <div class="small">Team: ${(job.team||'')}</div>
      <p>${(job.description||'')}</p>
      <div>
        <a class="btn" data-job="${job.job_id}">Details</a>
        <a class="btn ghost" data-complete="${job.job_id}">Mark complete</a>
      </div>`;
    list.appendChild(div);
  });
  // wire
  list.querySelectorAll('[data-complete]').forEach(el => el.addEventListener('click', async ev => {
    ev.preventDefault();
    const id = el.getAttribute('data-complete');
    if(!confirm('Mark '+id+' complete?')) return;
    const res = await updateJobViaJsonp(id, 'completed');
    if(res && res.ok){ await refreshJobsFromAPI(); renderJobList(); }
    else alert('Update failed: ' + (res && res.error ? res.error : 'unknown'));
  }));
  list.querySelectorAll('[data-job]').forEach(el => el.addEventListener('click', ev => {
    ev.preventDefault();
    const id = el.getAttribute('data-job');
    const job = allJobsCache.find(j => String(j.job_id) === String(id));
    alert('Job: ' + (job.title||id) + '\n\n' + (job.description||''));
  }));
}

/* Start */
async function start(){
  await loadInlineSVG('site.svg');
  await fetchZonesAndJobs();
}
start();

/* refresh on team change */
document.getElementById('teamFilter').addEventListener('change', ()=> renderJobList());

</script>
</body>
</html>
